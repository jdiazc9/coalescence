f_singleinv = numeric(0),
f_multiinv = numeric(0),
f_residentdom_multiinv = numeric(0))
# run through carbon sources and communities
for (cs in carbon_sources) {
for (i in 1:length(community_names)) {
for (j in 1:length(community_names)) {
# communities
comm_1 <- community_names[i] # by convention, community 1 will be the invasive and 2 the resident
comm_2 <- community_names[j]
# dominants of the communities
dom_1 <- names(dominants[[cs]])[grep(comm_1,dominants[[cs]])]
dom_2 <- names(dominants[[cs]])[grep(comm_2,dominants[[cs]])]
# proceed only if the dominants of both communities are defined and different
if (dom_1 != dom_2 & dom_1 != 'other' & dom_2 != 'other') {
# find wells of pairwise competition
champ_1 <- gsub('Community','Champion',comm_1)
champ_2 <- gsub('Community','Champion',comm_2)
wells_pairwise <- metadata[metadata$Comm1 == champ_1 &
metadata$Comm2 == champ_2 &
metadata$Carbon == cs
,]
# composition of pairwise competition wells
cc_pairwise <- otus[,wells_pairwise$Sample,drop=F]
# deconvolution matrix (isolates-to-ESVs map of dominants)
Q = isolates[['seq']][,c(dom_1,dom_2)]
# fraction of dominant 1 (invasive) in pairwise competition
f_pairwise <- rep(NA,ncol(cc_pairwise))
for (k in 1:ncol(cc_pairwise)) {
doms_abundance_pairwise <- species_composition_from_sequencing(Q,cc_pairwise[,k,drop=FALSE])
doms_abundance_pairwise <- doms_abundance_pairwise[c(dom_1,dom_2),]
doms_abundance_pairwise <- doms_abundance_pairwise/sum(doms_abundance_pairwise)
f_pairwise[k] <- doms_abundance_pairwise[dom_1]
}
# find all instances of community coalescence
wells_coalescence <- metadata[metadata$Comm1 == comm_1 &
metadata$Comm2 == comm_2 &
metadata$StabilizingCarb1 == cs &
metadata$StabilizingCarb2 == cs &
metadata$Carbon == cs
,]
# composition of coalesced community
cc_coalesced <- otus[,wells_coalescence$Sample,drop=F]
rownames(cc_coalesced) <- otus$seq_id
# composition of invasive and resident communities (average across replicates)
cc_invasive <- as.data.frame(rowMeans(communities[[cs]][[comm_1]]))
cc_resident <- as.data.frame(rowMeans(communities[[cs]][[comm_2]]))
# get species composition from ESV composition for invasive, resident and coalesced communities
Q <- isolates[['seq']]
cc_invasive <- as.data.frame(species_composition_from_sequencing(Q,cc_invasive))
cc_resident <- as.data.frame(species_composition_from_sequencing(Q,cc_resident))
cc_coalesced <- lapply(1:ncol(cc_coalesced),FUN=function(k) species_composition_from_sequencing(Q,cc_coalesced[,k,drop=FALSE]))
cc_coalesced <- as.data.frame(cc_coalesced[[1]])
# discard species with abundance 0 in all communities
all_comms <- merge(cc_invasive,cc_resident,by='row.names',all=T)
rownames(all_comms) <- all_comms$Row.names
all_comms <- all_comms[,2:3]
all_comms <- merge(all_comms,cc_coalesced,by='row.names',all=T)
rownames(all_comms) <- all_comms$Row.names
all_comms <- all_comms[,2:4]
all_comms[is.na(all_comms)] <- 0
n <- rowSums(all_comms)>0
cc_invasive <- all_comms[n,1,drop=FALSE]
cc_resident <- all_comms[n,2,drop=FALSE]
cc_coalesced <- all_comms[n,3,drop=FALSE]
# check that the row ordering is correct
stopifnot(all(rownames(cc_invasive)==rownames(cc_resident)))
stopifnot(all(rownames(cc_invasive)==rownames(cc_coalesced)))
# compositions of community cohorts (dominants removed)
cc_invasive_cohort <- cc_invasive[!rownames(cc_invasive) %in% c(dom_1,dom_2),,drop=FALSE]
cc_resident_cohort <- cc_resident[!rownames(cc_resident) %in% c(dom_1,dom_2),,drop=FALSE]
cc_coalesced_cohort <- cc_coalesced[!rownames(cc_coalesced) %in% c(dom_1,dom_2),,drop=FALSE]
# re-normalize cohort compositions
cc_invasive_cohort <- cc_invasive_cohort/matrix(rep(colSums(cc_invasive_cohort),nrow(cc_invasive_cohort)),
nrow=nrow(cc_invasive_cohort),
byrow=TRUE)
cc_resident_cohort <- cc_resident_cohort/matrix(rep(colSums(cc_resident_cohort),nrow(cc_resident_cohort)),
nrow=nrow(cc_resident_cohort),
byrow=TRUE)
cc_coalesced_cohort <- cc_coalesced_cohort/matrix(rep(colSums(cc_coalesced_cohort),nrow(cc_coalesced_cohort)),
nrow=nrow(cc_coalesced_cohort),
byrow=TRUE)
# relative similarity invasive-to-coalesced (bray_curtis)
sim_invasive <- cc_similarity(cc_invasive,cc_coalesced,metric='bray_curtis')
sim_resident <- cc_similarity(cc_resident,cc_coalesced,metric='bray_curtis')
q_bray_curtis <- sim_invasive/(sim_invasive + sim_resident)
# relative similarity invasive-to-coalesced (jaccard)
sim_invasive <- cc_similarity(cc_invasive,cc_coalesced,metric='jaccard')
sim_resident <- cc_similarity(cc_resident,cc_coalesced,metric='jaccard')
q_jaccard <- sim_invasive/(sim_invasive + sim_resident)
# relative similarity invasive-to-coalesced (jensen_shannon)
sim_invasive <- cc_similarity(cc_invasive,cc_coalesced,metric='jensen_shannon')
sim_resident <- cc_similarity(cc_resident,cc_coalesced,metric='jensen_shannon')
q_jensen_shannon <- sim_invasive/(sim_invasive + sim_resident)
# relative similarity invasive-to-coalesced (endemic species)
q_endemic <- rep(NA,ncol(cc_coalesced))
for (k in 1:ncol(cc_coalesced)) {
q_endemic[k] <- endemic(cc_invasive,cc_resident,cc_coalesced[,k])
}
# relative similarity invasive-to-coalesced (bray_curtis, cohorts)
sim_invasive <- cc_similarity(cc_invasive_cohort,cc_coalesced_cohort,metric='bray_curtis')
sim_resident <- cc_similarity(cc_resident_cohort,cc_coalesced_cohort,metric='bray_curtis')
q_bray_curtis_cohort <- sim_invasive/(sim_invasive + sim_resident)
# relative similarity invasive-to-coalesced (jaccard, cohorts)
sim_invasive <- cc_similarity(cc_invasive_cohort,cc_coalesced_cohort,metric='jaccard')
sim_resident <- cc_similarity(cc_resident_cohort,cc_coalesced_cohort,metric='jaccard')
q_jaccard_cohort <- sim_invasive/(sim_invasive + sim_resident)
# relative similarity invasive-to-coalesced (jensen_shannon, cohorts)
sim_invasive <- cc_similarity(cc_invasive_cohort,cc_coalesced_cohort,metric='jensen_shannon')
sim_resident <- cc_similarity(cc_resident_cohort,cc_coalesced_cohort,metric='jensen_shannon')
q_jensen_shannon_cohort <- sim_invasive/(sim_invasive + sim_resident)
# relative similarity invasive-to-coalesced (endemic species, cohorts)
q_endemic_cohort <- rep(NA,ncol(cc_coalesced_cohort))
for (k in 1:ncol(cc_coalesced_cohort)) {
q_endemic_cohort[k] <- endemic(cc_invasive_cohort,cc_resident_cohort,cc_coalesced_cohort[,k])
}
# frequency of invasive dominant invading resident community alone
wells_singleinv <- metadata[((metadata$Comm1 == champ_1 & metadata$Comm2 == comm_2) | (metadata$Comm1 == comm_2 & metadata$Comm2 == champ_1)) &
metadata$Carbon == cs
,]
cc_singleinv <- otus[,wells_singleinv$Sample,drop=F]
# invasive dominant ESV composition
Q = isolates[['seq']]
# fraction of dominant 1 (invasive) invading resident community alone
f_singleinv <- rep(NA,ncol(cc_singleinv))
for (k in 1:ncol(cc_singleinv)) {
doms_abundance_singleinv <- species_composition_from_sequencing(Q,cc_singleinv[,k,drop=FALSE])
f_singleinv[k] <- doms_abundance_singleinv[dom_1,]
}
# fraction of dominant 1 (invasive) invading resident community with cohort
f_multiinv <- as.numeric(cc_coalesced[dom_1,])
# fraction of dominant 2 (resident) when invasive community invades with cohort
f_residentdom_multiinv <- as.numeric(cc_coalesced[dom_2,])
# add to plotting table
plot_this <- rbind(plot_this,
data.frame(
carbon_source = cs,
community_1 = comm_1,
community_2 = comm_2,
isolate_1 = dom_1,
isolate_2 = dom_2,
plate_pairwise = wells_pairwise$Experiment,
well_pairwise = wells_pairwise$Well,
f_pairwise = f_pairwise,
plate_coalescence = wells_coalescence$Experiment,
well_coalescence = wells_coalescence$Well,
q_bray_curtis = q_bray_curtis,
q_jensen_shannon = q_jensen_shannon,
q_jaccard = q_jaccard,
q_endemic = q_endemic,
q_bray_curtis_cohort = q_bray_curtis_cohort,
q_jensen_shannon_cohort = q_jensen_shannon_cohort,
q_jaccard_cohort = q_jaccard_cohort,
q_endemic_cohort = q_endemic_cohort,
plate_singleinv = wells_singleinv$Experiment,
well_singleinv = wells_singleinv$Well,
f_singleinv = f_singleinv,
f_multiinv = f_multiinv,
f_residentdom_multiinv = f_residentdom_multiinv
))
}
}
}
}
ggplot(data=unique(plot_this[,c('carbon_source',
'community_1',
'community_2',
'f_singleinv',
'f_multiinv')]),
aes(x=f_singleinv,y=f_multiinv,
color=carbon_source)) +
annotate('polygon',
x=c(-0.1,poly$w,poly$w,-0.1,-0.1),
y=c(-0.1,poly$w,1.1,1.1,-0.1),
fill=poly$color[1]) +
annotate('polygon',
x=c(-0.1,poly$w,1.1,1.1,-0.1),
y=c(-0.1,poly$w,poly$w,-0.1,-0.1),
fill=poly$color[3]) +
annotate('polygon',
x=c(-0.1,1.1,1.1,1.1-1.2*poly$aperture,-0.1),
y=c(-0.1,1.1-1.2*poly$aperture,1.1,1.1,-0.1),
fill=poly$color[2]) +
geom_abline(intercept=0,
slope=1,
color='black',
linetype='dashed',
size=0.25) +
geom_point(size=3,
shape=1,
stroke=0.5) +
scale_y_continuous(name='Frequency of dominant\nspecies invading with cohort',
limits=c(-1,2),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_x_continuous(name='Frequency of dominant\nspecies invading alone\n ',
limits=c(-1,2),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_color_manual(values=pl_carbon) +
theme_bw() +
theme(panel.grid=element_blank(),
legend.title=element_blank(),
legend.position=c(0.2,0.9),
legend.background=element_rect(fill='transparent'),
text=element_text(size=15),
axis.text=element_text(size=15),
axis.line=element_blank(),
axis.ticks=element_line(size=0.25),
panel.border=element_rect(size=0.25)) +
coord_fixed(xlim=c(0,1),
ylim=c(0,1))
myplots[['q-vs-pairwise_bray-curtis_top-down-vs-bottom-up']] <-
ggplot(data=plot_this[plot_this$metric=='q_bray_curtis',],
aes(x=f_pairwise,y=value,
color=carbon_source,
group=bucs,
fill=bucs)) +
geom_point(aes(shape=bucs),
size=3,
stroke=0.5) +
geom_smooth(formula = y ~ x,
method = 'lm',
se = FALSE,
size = 0.5,
color = 'black') +
scale_y_continuous(name='Q\nCoalesced - Invasive',
limits=c(0,1),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_x_continuous(name='Frequency of\ninvasive dominant species\nin pairwise competition',
limits=c(0,1),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_color_manual(values=pl_carbon) +
scale_shape_manual(values=c(22,24)) +
scale_fill_manual(values=c('#e6e6e5','#52a25e')) +
theme_bw() +
theme(panel.grid=element_blank(),
legend.title=element_blank(),
legend.position=c(0.2,0.9),
legend.background=element_rect(fill='transparent'),
text=element_text(size=15),
axis.text=element_text(size=15),
axis.line=element_blank(),
axis.ticks=element_line(size=0.25),
panel.border=element_rect(size=0.25)) +
coord_fixed()
ggplot(data=plot_this[plot_this$metric=='q_bray_curtis'
& plot_this$bucs=='strong',],
aes(x=f_pairwise,y=value,
color=carbon_source)) +
geom_point(size=3,
stroke=0.5,
shape=1) +
geom_smooth(formula = y ~ x,
method = 'lm',
se = FALSE,
size = 0.5,
color = 'black') +
scale_y_continuous(name='Q\nCoalesced - Invasive',
limits=c(0,1),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_x_continuous(name='Frequency of\ninvasive dominant species\nin pairwise competition',
limits=c(0,1),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_color_manual(values=pl_carbon) +
theme_bw() +
theme(panel.grid=element_blank(),
legend.title=element_blank(),
legend.position=c(0.2,0.9),
legend.background=element_rect(fill='transparent'),
text=element_text(size=15),
axis.text=element_text(size=15),
axis.line=element_blank(),
axis.ticks=element_line(size=0.25),
panel.border=element_rect(size=0.25)) +
coord_fixed()
# check that sample positioning in wells is consistent
stopifnot(all(plot_this$well_pairwise == plot_this$well_coalescence))
# pseudo-pairwise competition of dominants with cohorts
plot_this$f_multiinv_rel <- plot_this$f_multiinv/(plot_this$f_multiinv + plot_this$f_residentdom_multiinv)
# strength of bottom-up co-selection
plot_this$bucs <- plot_this$f_singleinv < 0.15 & plot_this$f_multiinv > 0.05
plot_this$bucs <- c('neutral','strong')[1 + plot_this$bucs]
plot_this$bucs <- factor(plot_this$bucs,levels=c('neutral','strong'))
# reshape plotting table (this makes it easier to create multipanel plots)
plot_this <- gather(plot_this,metric,value,q_bray_curtis:q_endemic_cohort)
# characters as factors
plot_this$carbon_source <- factor(plot_this$carbon_source,levels=c('Glutamine','Citrate'))
plot_this$community_1 <- factor(plot_this$community_1,levels=community_names)
plot_this$community_2 <- factor(plot_this$community_2,levels=community_names)
plot_this$metric <- factor(plot_this$metric,levels=unique(plot_this$metric))
# parameters for annotations of plots
poly <- list(w=0.10,
aperture=0.15,
color=c('#d6e4d4',
'#e6e6e5',
'#fdd7c8'))
ggplot(data=unique(plot_this[,c('carbon_source',
'community_1',
'community_2',
'f_singleinv',
'f_multiinv')]),
aes(x=f_singleinv,y=f_multiinv,
color=carbon_source)) +
annotate('polygon',
x=c(-0.1,poly$w,poly$w,-0.1,-0.1),
y=c(-0.1,poly$w,1.1,1.1,-0.1),
fill=poly$color[1]) +
annotate('polygon',
x=c(-0.1,poly$w,1.1,1.1,-0.1),
y=c(-0.1,poly$w,poly$w,-0.1,-0.1),
fill=poly$color[3]) +
annotate('polygon',
x=c(-0.1,1.1,1.1,1.1-1.2*poly$aperture,-0.1),
y=c(-0.1,1.1-1.2*poly$aperture,1.1,1.1,-0.1),
fill=poly$color[2]) +
geom_abline(intercept=0,
slope=1,
color='black',
linetype='dashed',
size=0.25) +
geom_point(size=3,
shape=1,
stroke=0.5) +
scale_y_continuous(name='Frequency of dominant\nspecies invading with cohort',
limits=c(-1,2),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_x_continuous(name='Frequency of dominant\nspecies invading alone\n ',
limits=c(-1,2),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_color_manual(values=pl_carbon) +
theme_bw() +
theme(panel.grid=element_blank(),
legend.title=element_blank(),
legend.position=c(0.2,0.9),
legend.background=element_rect(fill='transparent'),
text=element_text(size=15),
axis.text=element_text(size=15),
axis.line=element_blank(),
axis.ticks=element_line(size=0.25),
panel.border=element_rect(size=0.25)) +
coord_fixed(xlim=c(0,1),
ylim=c(0,1))
ggplot(data=plot_this[plot_this$metric=='q_bray_curtis',],
aes(x=f_pairwise,y=value,
color=carbon_source,
group=bucs,
fill=bucs)) +
geom_point(aes(shape=bucs),
size=3,
stroke=0.5) +
geom_smooth(formula = y ~ x,
method = 'lm',
se = FALSE,
size = 0.5,
color = 'black') +
scale_y_continuous(name='Q\nCoalesced - Invasive',
limits=c(0,1),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_x_continuous(name='Frequency of\ninvasive dominant species\nin pairwise competition',
limits=c(0,1),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_color_manual(values=pl_carbon) +
scale_shape_manual(values=c(22,24)) +
scale_fill_manual(values=c('#e6e6e5','#52a25e')) +
theme_bw() +
theme(panel.grid=element_blank(),
legend.title=element_blank(),
legend.position=c(0.2,0.9),
legend.background=element_rect(fill='transparent'),
text=element_text(size=15),
axis.text=element_text(size=15),
axis.line=element_blank(),
axis.ticks=element_line(size=0.25),
panel.border=element_rect(size=0.25)) +
coord_fixed()
ggplot(data=plot_this[plot_this$metric=='q_bray_curtis'
& plot_this$bucs=='strong',],
aes(x=f_pairwise,y=value,
color=carbon_source)) +
geom_point(size=3,
stroke=0.5,
shape=1) +
geom_smooth(formula = y ~ x,
method = 'lm',
se = FALSE,
size = 0.5,
color = 'black') +
scale_y_continuous(name='Q\nCoalesced - Invasive',
limits=c(0,1),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_x_continuous(name='Frequency of\ninvasive dominant species\nin pairwise competition',
limits=c(0,1),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_color_manual(values=pl_carbon) +
theme_bw() +
theme(panel.grid=element_blank(),
legend.title=element_blank(),
legend.position=c(0.2,0.9),
legend.background=element_rect(fill='transparent'),
text=element_text(size=15),
axis.text=element_text(size=15),
axis.line=element_blank(),
axis.ticks=element_line(size=0.25),
panel.border=element_rect(size=0.25)) +
coord_fixed()
ggplot(data=plot_this[plot_this$metric=='q_bray_curtis'
& plot_this$bucs=='neutral',],
aes(x=f_pairwise,y=value,
color=carbon_source)) +
geom_point(size=3,
stroke=0.5,
shape=1) +
geom_smooth(formula = y ~ x,
method = 'lm',
se = FALSE,
size = 0.5,
color = 'black') +
scale_y_continuous(name='Q\nCoalesced - Invasive',
limits=c(0,1),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_x_continuous(name='Frequency of\ninvasive dominant species\nin pairwise competition',
limits=c(0,1),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_color_manual(values=pl_carbon) +
theme_bw() +
theme(panel.grid=element_blank(),
legend.title=element_blank(),
legend.position=c(0.2,0.9),
legend.background=element_rect(fill='transparent'),
text=element_text(size=15),
axis.text=element_text(size=15),
axis.line=element_blank(),
axis.ticks=element_line(size=0.25),
panel.border=element_rect(size=0.25)) +
coord_fixed()
ggplot(data=plot_this[plot_this$metric=='q_bray_curtis'
& plot_this$bucs=='strong',],
aes(x=f_pairwise,y=value,
color=carbon_source)) +
geom_point(size=3,
stroke=0.5,
shape=1) +
geom_smooth(formula = y ~ x,
method = 'lm',
se = FALSE,
size = 0.5,
color = 'black') +
scale_y_continuous(name='Q\nCoalesced - Invasive',
limits=c(0,1),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_x_continuous(name='Frequency of\ninvasive dominant species\nin pairwise competition',
limits=c(0,1),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_color_manual(values=pl_carbon) +
theme_bw() +
theme(panel.grid=element_blank(),
legend.title=element_blank(),
legend.position=c(0.2,0.9),
legend.background=element_rect(fill='transparent'),
text=element_text(size=15),
axis.text=element_text(size=15),
axis.line=element_blank(),
axis.ticks=element_line(size=0.25),
panel.border=element_rect(size=0.25)) +
coord_fixed()
ggplot(data=plot_this[plot_this$metric=='q_bray_curtis'
& plot_this$bucs=='neutral',],
aes(x=f_pairwise,y=value,
color=carbon_source)) +
geom_point(size=3,
stroke=0.5,
shape=1) +
geom_smooth(formula = y ~ x,
method = 'lm',
se = FALSE,
size = 0.5,
color = 'black') +
scale_y_continuous(name='Q\nCoalesced - Invasive',
limits=c(0,1),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_x_continuous(name='Frequency of\ninvasive dominant species\nin pairwise competition',
limits=c(0,1),
breaks=c(0,0.5,1),
labels=c('0','0.5','1')) +
scale_color_manual(values=pl_carbon) +
theme_bw() +
theme(panel.grid=element_blank(),
legend.title=element_blank(),
legend.position=c(0.2,0.9),
legend.background=element_rect(fill='transparent'),
text=element_text(size=15),
axis.text=element_text(size=15),
axis.line=element_blank(),
axis.ticks=element_line(size=0.25),
panel.border=element_rect(size=0.25)) +
coord_fixed()
